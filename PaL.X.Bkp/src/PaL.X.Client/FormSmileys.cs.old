using PaL.X.Client.Services;
using System;
using System.Collections.Generic;
using System.Drawing;
using System.Linq;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace PaL.X.Client
{
    internal sealed class FormSmileys : Form
    {
        private static readonly string[] DefaultPriority =
        {
            "@_Smile.gif",
            "@_Slightly-happy.gif",
            "@_Laughing.gif",
            "@_Joy.gif",
            "@_Heart-eyes.gif",
            "@_Sunglasses-face.gif",
            "@_Neutral-face.gif",
            "@_Wink.gif",
            "@_Cry.gif",
            "@_Angry.gif",
            "@_Sad.gif",
            "@_Smirk.gif"
        };

        private static readonly (string Id, string[] Priority)[] CategoryDefinitions =
        {
            ("Emoticonam", DefaultPriority),
            ("21_Slightly-happy", Array.Empty<string>()),
            ("160_Two-hearts", Array.Empty<string>()),
            ("221_Thumbs-up", Array.Empty<string>()),
            ("138_Fire", Array.Empty<string>()),
            ("547_Rooster", Array.Empty<string>()),
            ("593_Tropical-drink", Array.Empty<string>()),
            ("666_Shovel", Array.Empty<string>())
        };

        private readonly FlowLayoutPanel _categoryPanel;
        private readonly FlowLayoutPanel _smileyPanel;
        private readonly Dictionary<string, PictureBox> _categoryButtons = new(StringComparer.OrdinalIgnoreCase);
        private readonly Dictionary<string, Image> _categoryIcons = new(StringComparer.OrdinalIgnoreCase);
        private readonly Dictionary<string, SmileyCategory> _categories = new(StringComparer.OrdinalIgnoreCase);
        private SmileyCategory? _activeCategory;

        public event Action<SmileySelection>? OnSmileySelected;

        public FormSmileys()
        {
            FormBorderStyle = FormBorderStyle.None;
            ShowInTaskbar = false;
            StartPosition = FormStartPosition.Manual;
            Size = new Size(320, 220);
            BackColor = Color.White;
            Padding = new Padding(6);
            DoubleBuffered = true;
            KeyPreview = true;

            Paint += (_, e) => ControlPaint.DrawBorder(e.Graphics, ClientRectangle, Color.LightGray, ButtonBorderStyle.Solid);

            _categoryPanel = new FlowLayoutPanel
            {
                Dock = DockStyle.Top,
                Height = 46,
                FlowDirection = FlowDirection.LeftToRight,
                WrapContents = false,
                AutoScroll = false,
                BackColor = Color.White,
                Padding = new Padding(2, 2, 2, 0)
            };
            Controls.Add(_categoryPanel);

            _smileyPanel = new FlowLayoutPanel
            {
                Dock = DockStyle.Fill,
                AutoScroll = true,
                Padding = new Padding(2, 4, 2, 2)
            };
            Controls.Add(_smileyPanel);

            InitializeCategories();
            Deactivate += (_, _) => Close();
            KeyDown += (_, e) =>
            {
                if (e.KeyCode == Keys.Escape)
                {
                    Close();
                }
            };
        }

        private void InitializeCategories()
        {
            _categoryPanel.SuspendLayout();

            var available = ResourceImageStore.GetSmileyCategories();
            var registered = new HashSet<string>(StringComparer.OrdinalIgnoreCase);

            foreach (var (id, priority) in CategoryDefinitions)
            {
                if (TryCreateCategory(id, priority, available, out var category))
                {
                    registered.Add(id);
                    _categories[id] = category;
                    var button = CreateCategoryButton(category);
                    _categoryButtons[id] = button;
                    _categoryPanel.Controls.Add(button);
                }
            }

            foreach (var kvp in available.OrderBy(k => k.Key, StringComparer.OrdinalIgnoreCase))
            {
                if (registered.Contains(kvp.Key))
                {
                    continue;
                }

                if (TryCreateCategory(kvp.Key, Array.Empty<string>(), available, out var category))
                {
                    _categories[kvp.Key] = category;
                    var button = CreateCategoryButton(category);
                    _categoryButtons[kvp.Key] = button;
                    _categoryPanel.Controls.Add(button);
                }
            }

            _categoryPanel.ResumeLayout();

            var initialCategory = _categories.Values.FirstOrDefault();
            if (initialCategory != null)
            {
                ActivateCategory(initialCategory.Id);
            }
        }

        private bool TryCreateCategory(string id, string[] priority, IReadOnlyDictionary<string, IReadOnlyList<string>> available, out SmileyCategory category)
        {
            category = null!;
            if (!available.TryGetValue(id, out var resources) || resources.Count == 0)
            {
                return false;
            }

            var ordered = OrderSmileys(resources, priority);
            if (ordered.Count == 0)
            {
                return false;
            }

            var iconKey = SelectIconKey(ordered, priority);
            category = new SmileyCategory(id, ordered, iconKey);
            return true;
        }

        private IReadOnlyList<string> OrderSmileys(IReadOnlyList<string> resourceKeys, string[] priority)
        {
            var ordered = new List<string>();
            var remaining = new List<string>(resourceKeys);
            var comparer = StringComparer.OrdinalIgnoreCase;

            foreach (var fileName in priority)
            {
                var match = remaining.FirstOrDefault(key => comparer.Equals(GetFileName(key), fileName));
                if (match == null)
                {
                    continue;
                }

                ordered.Add(match);
                remaining.Remove(match);
            }

            remaining.Sort((a, b) => string.Compare(GetFileName(a), GetFileName(b), StringComparison.OrdinalIgnoreCase));
            ordered.AddRange(remaining);
            return ordered;
        }

        private static string SelectIconKey(IReadOnlyList<string> ordered, string[] priority)
        {
            var comparer = StringComparer.OrdinalIgnoreCase;
            foreach (var fileName in priority)
            {
                var match = ordered.FirstOrDefault(key => comparer.Equals(GetFileName(key), fileName));
                if (match != null)
                {
                    return match;
                }
            }

            return ordered[0];
        }

        private PictureBox CreateCategoryButton(SmileyCategory category)
        {
            var button = new PictureBox
            {
                Size = new Size(36, 36),
                SizeMode = PictureBoxSizeMode.Zoom,
                Cursor = Cursors.Hand,
                Margin = new Padding(4, 4, 4, 0),
                BackColor = Color.White,
                Tag = category.Id
            };

            if (TryLoadCategoryIcon(category, out var icon))
            {
                button.Image = icon;
            }

            button.Click += (_, _) => ActivateCategory(category.Id);
            return button;
        }

        private bool TryLoadCategoryIcon(SmileyCategory category, out Image? icon)
        {
            if (_categoryIcons.TryGetValue(category.Id, out var cached))
            {
                icon = cached;
                return true;
            }

            icon = ResourceImageStore.LoadImage(category.IconResourceKey);
            if (icon != null)
            {
                _categoryIcons[category.Id] = icon;
                return true;
            }

            return false;
        }

        private void ActivateCategory(string categoryId)
        {
            if (!_categories.TryGetValue(categoryId, out var category))
            {
                return;
            }

            if (_activeCategory?.Id == category.Id)
            {
                return;
            }

            _activeCategory = category;
            UpdateCategoryButtonStyles();
            PopulateSmileys(category);
        }

        private void UpdateCategoryButtonStyles()
        {
            foreach (var kvp in _categoryButtons)
            {
                bool isActive = string.Equals(kvp.Key, _activeCategory?.Id, StringComparison.OrdinalIgnoreCase);
                kvp.Value.BackColor = isActive ? Color.FromArgb(225, 240, 255) : Color.White;
                kvp.Value.Padding = isActive ? new Padding(2) : Padding.Empty;
                kvp.Value.BorderStyle = isActive ? BorderStyle.FixedSingle : BorderStyle.None;
            }
        }

        private void PopulateSmileys(SmileyCategory category)
        {
            _smileyPanel.SuspendLayout();
            _smileyPanel.Controls.Clear();

            foreach (var resourceKey in category.SmileyResourceKeys)
            {
                AddSmileyControl(category, resourceKey);
            }

            _smileyPanel.ResumeLayout();
        }

        private void AddSmileyControl(SmileyCategory category, string resourceKey)
        {
            var picture = new PictureBox
            {
                Size = new Size(32, 32),
                SizeMode = PictureBoxSizeMode.Zoom,
                Cursor = Cursors.Hand,
                Margin = new Padding(4),
                BackColor = Color.WhiteSmoke
            };

            picture.Click += (_, _) =>
            {
                var fileName = GetFileName(resourceKey);
                OnSmileySelected?.Invoke(new SmileySelection(category.Id, fileName, resourceKey));
            };

            _smileyPanel.Controls.Add(picture);
            Task.Run(() => LoadSmileyIntoControl(picture, resourceKey));
        }

        private void LoadSmileyIntoControl(PictureBox target, string resourceKey)
        {
            try
            {
                var image = ResourceImageStore.LoadStaticImage(resourceKey, new Size(32, 32));
                if (image == null)
                {
                    return;
                }

                if (target.IsDisposed || IsDisposed)
                {
                    image.Dispose();
                    return;
                }

                target.BeginInvoke(new Action(() =>
                {
                    if (target.IsDisposed)
                    {
                        image.Dispose();
                        return;
                    }

                    target.BackColor = Color.Transparent;
                    var previous = target.Image;
                    target.Image = image;
                    previous?.Dispose();
                }));
            }
            catch
            {
                // ignore loading failures
            }
        }

        private static string GetFileName(string resourceKey)
        {
            var separatorIndex = resourceKey.LastIndexOf('/') + 1;
            return separatorIndex > 0 && separatorIndex < resourceKey.Length
                ? resourceKey[separatorIndex..]
                : resourceKey;
        }

        protected override void Dispose(bool disposing)
        {
            if (disposing)
            {
                foreach (var icon in _categoryIcons.Values)
                {
                    icon.Dispose();
                }

                _categoryIcons.Clear();
            }

            base.Dispose(disposing);
        }

        private sealed class SmileyCategory
        {
            public SmileyCategory(string id, IReadOnlyList<string> smileyResourceKeys, string iconResourceKey)
            {
                Id = id;
                SmileyResourceKeys = smileyResourceKeys;
                IconResourceKey = iconResourceKey;
            }

            public string Id { get; }
            public IReadOnlyList<string> SmileyResourceKeys { get; }
            public string IconResourceKey { get; }
        }
    }

    internal sealed class SmileySelection
    {
        public SmileySelection(string categoryId, string fileName, string resourceKey)
        {
            CategoryId = categoryId;
            FileName = fileName;
            ResourceKey = resourceKey;
        }

        public string CategoryId { get; }
        public string FileName { get; }
        public string ResourceKey { get; }
    }
}

